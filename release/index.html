<!doctype html>
<html lang="en">
    <head>
        <title>Air search test</title>
        <script src="client.js"></script>
    </head>
    <body>
        <input
            type="text"
            id="searchInput"
            placeholder="Search Latvian company"
        />

        <div id="results"></div>
        <script>
            function listener(event) {
                const resultsDiv = document.getElementById("results");
                // PARSE RESULT,
                // IT CAN BE SEARCH RESULT, PONG OR ERROR MESSAGE
                let message = air.listen(event);
                // RESULT IS AN ARRAY
                if (message && message.result && message.result[0]) {
                    // PRINT RESULTS TO DIV
                    resultsDiv.innerHTML = "";
                    for (let i = 0; i < message.result.length; i++) {
                        resultsDiv.innerHTML += `<p>${JSON.stringify(message.result[i])}</p>`;
                    }
                } else {
                    console.log("not");
                }
            }
            function printMessage(socket) {
                // REMOVE OLD
                socket.removeEventListener("message", listener);
                // ADD NEW
                socket.addEventListener("message", listener);
            }

            document.addEventListener("DOMContentLoaded", function () {
                // GET ELEMENTS
                const searchInput = document.getElementById("searchInput");
                // START SOCKET
                let socket = air.start();
                socket.addEventListener("open", function (event) {
                    // LISTEN TO MESSAGES IN SOCKET AND PRINT THEM
                    printMessage(socket);
                    // SEARCH ON KEYPRESS
                    searchInput.addEventListener("input", function () {
                        const searchTerm = searchInput.value.trim();

                        air.search(searchTerm, function (err, result) {
                            if (err) {
                                console.error(err);
                                // RESTART ON ERROR
                                socket = air.start();
                                // NEW LISTENER FOR NEW SOCKET
                                printMessage(socket);
                            }
                        });
                    });
                });
            });
        </script>
    </body>
</html>
